<section style="font-size: 17px;color: black;padding: 0px 10px;line-height: 1.7;word-spacing:0px;letter-spacing: 0.01px;word-break: break-word;overflow-wrap: break-word;text-align: left;font-family:Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, " PingFang SC", Cambria, Cochin, Georgia,Times, "Times New Roman" , serif;"><section><section style="margin-top: 10px; margin-bottom: 10px; text-align: center;"><section style="display: inline-block; vertical-align: top;"><section                    style="margin-bottom: -6px; line-height: 1em; padding-left: 2px; padding-right: 2px; font-size: 18px; color: rgb(72, 64, 64);">                <p><strong>需求</strong></p>            </section><section style="width: 100%; height: 10px; background-color: rgb(255, 202, 0);">                <br/>            </section>        </section>    </section></section><p style="font-size: 17px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px;">iOS系统自带语音效果不佳，最近接触到Azure TTS服务效果良好。想在读书软件香色闺阁中加入Azure tts音色。</p><section><section style="margin-top: 10px; margin-bottom: 10px; text-align: center;"><section style="display: inline-block; vertical-align: top;"><section                    style="margin-bottom: -6px; line-height: 1em; padding-left: 2px; padding-right: 2px; font-size: 18px; color: rgb(72, 64, 64);">                <p><strong>方案</strong></p>            </section><section style="width: 100%; height: 10px; background-color: rgb(255, 202, 0);">                <br/>            </section>        </section>    </section></section><p style="font-size: 17px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px;">在服务端对Azure tts服务进行封装，对外提供接口。香色闺阁中调用接口，实现朗读。</p><section><strong><span style="font-size: 17px;"><strong                style="color: rgb(90, 120, 234);font-size: 17px;letter-spacing: normal;text-align: left;">----------------</strong><br /></span></strong><section style="letter-spacing: 0.544px;text-indent: 0em;white-space: normal;background-color: rgb(255, 255, 255);"><strong><span style="font-size: 17px;"></span></strong><span            style="font-size: 17px;color: rgb(255, 64, 129);"><strong>Azure tts</strong></span>    </section><section style="letter-spacing: 0.544px;text-indent: 0em;white-space: normal;background-color: rgb(255, 255, 255);">        <span style="font-size: 17px;color: rgb(255, 64, 129);"><strong><br /></strong></span>    </section></section><ol><li>先注册Azure账号，Azure AI services|语音服务中创建项目，获取秘钥和区域。密钥和区域写入环境变量中，方便使用。</li><li>安装python SDK，pip install azure-cognitiveservices-speech</li><li>参考<a href="https://learn.microsoft.com/en-us/azure/ai-services/speech-service/get-started-text-to-speech?tabs=linux%2Cterminal&pivots=programming-language-python">官方文档</a></li><li>获取音色配置文件，完成文本转语音功能。</li></ol><section><strong><span style="font-size: 17px;"><strong                style="color: rgb(90, 120, 234);font-size: 17px;letter-spacing: normal;text-align: left;">----------------</strong><br /></span></strong><section style="letter-spacing: 0.544px;text-indent: 0em;white-space: normal;background-color: rgb(255, 255, 255);"><strong><span style="font-size: 17px;"></span></strong><span            style="font-size: 17px;color: rgb(255, 64, 129);"><strong>音色列表</strong></span>    </section><section style="letter-spacing: 0.544px;text-indent: 0em;white-space: normal;background-color: rgb(255, 255, 255);">        <span style="font-size: 17px;color: rgb(255, 64, 129);"><strong><br /></strong></span>    </section></section><ul><li>获取音色列表形成音色配置文件config.ini。</li></ul><div class="codehilite" style="background: #f0f0f0"><pre style="line-height: 125%;"><span></span><code style="font-size: 13.6px;padding: 0.2em 0.4em;border-radius: 3px;display: block;overflow: auto;text-wrap: wrap;font-family: mononoki, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace, &quot;Apple Color Emoji&quot;, &quot;Segoe UI Emoji&quot;, &quot;Noto Color Emoji&quot;, &quot;Segoe UI Symbol&quot;, &quot;Android Emoji&quot;, EmojiSymbols;background-size: 20px 20px;background-image: none;word-break: break-word;overflow-wrap: normal;background-color: rgba(27, 31, 35, 0.05);max-height: 1000px;color: var(--vscode-editor-foreground) !important;border-color: var(--vscode-quickInputTitle-background) !important;"><span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">requests</span><br  \><span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">json</span><br  \><span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">configparser</span><br  \><span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">os</span><br  \><span style="color: #60a0b0; font-style: italic"># URL地址</span><br  \>url <span style="color: #666666">=</span> <span style="color: #4070a0">&#39;https://japanwest.tts.speech.microsoft.com/cognitiveservices/voices/list&#39;</span><br  \><br  \><span style="color: #60a0b0; font-style: italic"># 定义headers</span><br  \>headers <span style="color: #666666">=</span> {<br  \>    <span style="color: #4070a0">&#39;User-Agent&#39;</span>: <span style="color: #4070a0">&#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.3&#39;</span>,<br  \>    <span style="color: #4070a0">&#39;Accept&#39;</span>: <span style="color: #4070a0">&#39;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8&#39;</span>,<br  \>    <span style="color: #4070a0">&#39;Accept-Encoding&#39;</span>: <span style="color: #4070a0">&#39;gzip, deflate, sdch&#39;</span>,<br  \>    <span style="color: #4070a0">&#39;Accept-Language&#39;</span>: <span style="color: #4070a0">&#39;en-US,en;q=0.8,zh-CN;q=0.6,zh;q=0.4&#39;</span>,<br  \>    <span style="color: #4070a0">&#39;Ocp-Apim-Subscription-Key&#39;</span>:os<span style="color: #666666">.</span>environ<span style="color: #666666">.</span>get(<span style="color: #4070a0">&#39;SPEECH_KEY&#39;</span>),<br  \>    <span style="color: #60a0b0; font-style: italic"># 其他您需要的headers</span><br  \>}<br  \><br  \><span style="color: #60a0b0; font-style: italic"># 发送GET请求，包含headers</span><br  \>response <span style="color: #666666">=</span> requests<span style="color: #666666">.</span>get(url, headers<span style="color: #666666">=</span>headers)<br  \><br  \><span style="color: #60a0b0; font-style: italic"># 检查请求是否成功</span><br  \><span style="color: #007020; font-weight: bold">if</span> response<span style="color: #666666">.</span>status_code <span style="color: #666666">==</span> <span style="color: #40a070">200</span>:<br  \>    config <span style="color: #666666">=</span> configparser<span style="color: #666666">.</span>ConfigParser()<br  \>    config<span style="color: #666666">.</span>read(<span style="color: #4070a0">&#39;config.ini&#39;</span>)<br  \>    config[<span style="color: #4070a0">&#39;voice&#39;</span>]<span style="color: #666666">=</span>{}<br  \>    <span style="color: #60a0b0; font-style: italic"># 输出返回的数据</span><br  \>    data <span style="color: #666666">=</span> json<span style="color: #666666">.</span>loads(response<span style="color: #666666">.</span>text)<br  \>    <span style="color: #007020; font-weight: bold">for</span> voice <span style="color: #007020; font-weight: bold">in</span> data:<br  \>        <span style="color: #007020; font-weight: bold">if</span> voice[<span style="color: #4070a0">&#39;Locale&#39;</span>] <span style="color: #666666">==</span> <span style="color: #4070a0">&#39;zh-CN&#39;</span> <span style="color: #007020; font-weight: bold">or</span> voice[<span style="color: #4070a0">&#39;Locale&#39;</span>] <span style="color: #666666">==</span> <span style="color: #4070a0">&#39;zh-TW&#39;</span>:<br  \>            config[<span style="color: #4070a0">&#39;voice&#39;</span>][voice[<span style="color: #4070a0">&#39;DisplayName&#39;</span>]] <span style="color: #666666">=</span>voice[<span style="color: #4070a0">&#39;ShortName&#39;</span>]<br  \>    <span style="color: #007020; font-weight: bold">with</span> <span style="color: #007020">open</span>(<span style="color: #4070a0">&#39;config.ini&#39;</span>, <span style="color: #4070a0">&#39;w&#39;</span>,encoding<span style="color: #666666">=</span><span style="color: #4070a0">&#39;utf-8&#39;</span>) <span style="color: #007020; font-weight: bold">as</span> configfile:<br  \>        config<span style="color: #666666">.</span>write(configfile)<br  \><span style="color: #007020; font-weight: bold">else</span>:<br  \>    <span style="color: #60a0b0; font-style: italic"># 输出错误信息</span><br  \>    <span style="color: #007020">print</span>(<span style="color: #4070a0">&#39;Error:&#39;</span>, response<span style="color: #666666">.</span>status_code)<br  \></code></pre></div><section><strong><span style="font-size: 17px;"><strong                style="color: rgb(90, 120, 234);font-size: 17px;letter-spacing: normal;text-align: left;">----------------</strong><br /></span></strong><section style="letter-spacing: 0.544px;text-indent: 0em;white-space: normal;background-color: rgb(255, 255, 255);"><strong><span style="font-size: 17px;"></span></strong><span            style="font-size: 17px;color: rgb(255, 64, 129);"><strong>文本转语音</strong></span>    </section><section style="letter-spacing: 0.544px;text-indent: 0em;white-space: normal;background-color: rgb(255, 255, 255);">        <span style="font-size: 17px;color: rgb(255, 64, 129);"><strong><br /></strong></span>    </section></section><ul><li>config.ini文件与下面代码放在同一目录下。</li></ul><div class="codehilite" style="background: #f0f0f0"><pre style="line-height: 125%;"><span></span><code style="font-size: 13.6px;padding: 0.2em 0.4em;border-radius: 3px;display: block;overflow: auto;text-wrap: wrap;font-family: mononoki, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace, &quot;Apple Color Emoji&quot;, &quot;Segoe UI Emoji&quot;, &quot;Noto Color Emoji&quot;, &quot;Segoe UI Symbol&quot;, &quot;Android Emoji&quot;, EmojiSymbols;background-size: 20px 20px;background-image: none;word-break: break-word;overflow-wrap: normal;background-color: rgba(27, 31, 35, 0.05);max-height: 1000px;color: var(--vscode-editor-foreground) !important;border-color: var(--vscode-quickInputTitle-background) !important;"><span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">azure.cognitiveservices.speech</span> <span style="color: #007020; font-weight: bold">as</span> <span style="color: #0e84b5; font-weight: bold">speechsdk</span><br  \><span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">os</span><br  \><span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">configparser</span><br  \><br  \><span style="color: #007020; font-weight: bold">class</span> <span style="color: #0e84b5; font-weight: bold">tts</span>():<br  \>    <span style="color: #007020; font-weight: bold">def</span> <span style="color: #06287e">__init__</span>(<span style="color: #007020">self</span>):<br  \>        <span style="color: #007020">self</span><span style="color: #666666">.</span>config <span style="color: #666666">=</span> configparser<span style="color: #666666">.</span>ConfigParser()<br  \>        <span style="color: #007020">self</span><span style="color: #666666">.</span>config<span style="color: #666666">.</span>read(<span style="color: #4070a0">&#39;config.ini&#39;</span>)<br  \><br  \>    <span style="color: #007020; font-weight: bold">def</span> <span style="color: #06287e">speak</span>(<span style="color: #007020">self</span>, voice_id,text):<br  \>        path <span style="color: #666666">=</span> <span style="color: #4070a0">&#39;/home/ubuntu/tts/output.wav&#39;</span><br  \>        speech_config <span style="color: #666666">=</span> speechsdk<span style="color: #666666">.</span>SpeechConfig(subscription<span style="color: #666666">=</span>os<span style="color: #666666">.</span>environ<span style="color: #666666">.</span>get(<span style="color: #4070a0">&#39;SPEECH_KEY&#39;</span>), region<span style="color: #666666">=</span><span style="color: #4070a0">&quot;japanwest&quot;</span>)  <br  \>        file_config <span style="color: #666666">=</span> speechsdk<span style="color: #666666">.</span>audio<span style="color: #666666">.</span>AudioOutputConfig(filename<span style="color: #666666">=</span>path)<br  \>        speech_config<span style="color: #666666">.</span>speech_synthesis_voice_name<span style="color: #666666">=</span> <span style="color: #007020">self</span><span style="color: #666666">.</span>config[<span style="color: #4070a0">&#39;voices&#39;</span>][voice_id]<br  \>        speech_synthesizer <span style="color: #666666">=</span> speechsdk<span style="color: #666666">.</span>SpeechSynthesizer(speech_config<span style="color: #666666">=</span>speech_config, audio_config<span style="color: #666666">=</span>file_config)  <br  \>        speech_synthesis_result <span style="color: #666666">=</span> speech_synthesizer<span style="color: #666666">.</span>speak_text_async(text)<span style="color: #666666">.</span>get()<br  \>        <span style="color: #007020; font-weight: bold">return</span> path,speech_synthesis_result<br  \><br  \><span style="color: #007020; font-weight: bold">if</span> <span style="color: #bb60d5">__name__</span> <span style="color: #666666">==</span> <span style="color: #4070a0">&quot;__main__&quot;</span>:<br  \>    text_to_tts <span style="color: #666666">=</span> tts()<br  \>    text_to_tts<span style="color: #666666">.</span>speak(<span style="color: #4070a0">&quot;yunxia&quot;</span>,<span style="color: #4070a0">&quot;2019/03/02上午有1/2的概率下暴雨所以有600人選擇3:30p.m.再出門,支付$500或￥600可以獲得代金券&quot;</span>)<br  \></code></pre></div><section><strong><span style="font-size: 17px;"><strong                style="color: rgb(90, 120, 234);font-size: 17px;letter-spacing: normal;text-align: left;">----------------</strong><br /></span></strong><section style="letter-spacing: 0.544px;text-indent: 0em;white-space: normal;background-color: rgb(255, 255, 255);"><strong><span style="font-size: 17px;"></span></strong><span            style="font-size: 17px;color: rgb(255, 64, 129);"><strong>对外接口</strong></span>    </section><section style="letter-spacing: 0.544px;text-indent: 0em;white-space: normal;background-color: rgb(255, 255, 255);">        <span style="font-size: 17px;color: rgb(255, 64, 129);"><strong><br /></strong></span>    </section></section><ul><li>基于fastapi编写对外服务接口。</li></ul><div class="codehilite" style="background: #f0f0f0"><pre style="line-height: 125%;"><span></span><code style="font-size: 13.6px;padding: 0.2em 0.4em;border-radius: 3px;display: block;overflow: auto;text-wrap: wrap;font-family: mononoki, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace, &quot;Apple Color Emoji&quot;, &quot;Segoe UI Emoji&quot;, &quot;Noto Color Emoji&quot;, &quot;Segoe UI Symbol&quot;, &quot;Android Emoji&quot;, EmojiSymbols;background-size: 20px 20px;background-image: none;word-break: break-word;overflow-wrap: normal;background-color: rgba(27, 31, 35, 0.05);max-height: 1000px;color: var(--vscode-editor-foreground) !important;border-color: var(--vscode-quickInputTitle-background) !important;"><span style="color: #007020; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">fastapi</span> <span style="color: #007020; font-weight: bold">import</span> FastAPI,Query<br  \><span style="color: #007020; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">fastapi.responses</span> <span style="color: #007020; font-weight: bold">import</span> FileResponse<br  \><span style="color: #007020; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">pydantic</span> <span style="color: #007020; font-weight: bold">import</span> BaseModel<br  \><span style="color: #007020; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">speech_synthesis</span> <span style="color: #007020; font-weight: bold">import</span> tts<br  \><span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">os</span><br  \><span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">uvicorn</span><br  \><br  \><span style="color: #60a0b0; font-style: italic"># class TTSRequest(BaseModel):</span><br  \><span style="color: #60a0b0; font-style: italic">#     voice_id: str  # 假设voice_id是一个整数</span><br  \><span style="color: #60a0b0; font-style: italic">#     text: str      # text是一个字符串</span><br  \><br  \>app <span style="color: #666666">=</span> FastAPI()<br  \><br  \><span style="color: #60a0b0; font-style: italic"># @app.get(&quot;/tts/&quot;)</span><br  \><span style="color: #60a0b0; font-style: italic"># async def handle_tts(request: TTSRequest):</span><br  \><span style="color: #60a0b0; font-style: italic">#     text_to_speech = tts()</span><br  \><span style="color: #60a0b0; font-style: italic">#     audio_file_path,speech_synthesis_result = text_to_speech.speak(request.voice_id, request.text)</span><br  \><br  \><span style="color: #60a0b0; font-style: italic">#     if os.path.isfile(audio_file_path):</span><br  \><span style="color: #60a0b0; font-style: italic">#         # 使用 FileResponse 返回文件内容</span><br  \><span style="color: #60a0b0; font-style: italic">#         return FileResponse(audio_file_path, filename=&quot;output.wav&quot;, media_type=&quot;audio/wav&quot;)</span><br  \><span style="color: #60a0b0; font-style: italic">#     else:</span><br  \><span style="color: #60a0b0; font-style: italic">#         print(&quot;audio_file_path: &quot; + audio_file_path)</span><br  \><span style="color: #60a0b0; font-style: italic">#         print(speech_synthesis_result)</span><br  \><span style="color: #60a0b0; font-style: italic">#         return {&quot;error&quot;: &quot;File not found&quot;}, 404</span><br  \><br  \><span style="color: #555555; font-weight: bold">@app</span><span style="color: #666666">.</span>get(<span style="color: #4070a0">&quot;/tts/&quot;</span>)<br  \><span style="color: #007020; font-weight: bold">async</span> <span style="color: #007020; font-weight: bold">def</span> <span style="color: #06287e">handle_tts</span>(voice_id: <span style="color: #007020">str</span> <span style="color: #666666">=</span> Query(<span style="color: #007020; font-weight: bold">None</span>, description<span style="color: #666666">=</span><span style="color: #4070a0">&quot;The ID of the voice to use&quot;</span>),<br  \>                     text: <span style="color: #007020">str</span> <span style="color: #666666">=</span> Query(<span style="color: #007020; font-weight: bold">None</span>, description<span style="color: #666666">=</span><span style="color: #4070a0">&quot;The text to be synthesized&quot;</span>)):<br  \>    text_to_speech <span style="color: #666666">=</span> tts()<br  \>    audio_file_path,speech_synthesis_result <span style="color: #666666">=</span> text_to_speech<span style="color: #666666">.</span>speak(voice_id, text)<br  \><br  \>    <span style="color: #007020; font-weight: bold">if</span> os<span style="color: #666666">.</span>path<span style="color: #666666">.</span>isfile(audio_file_path):<br  \>        <span style="color: #60a0b0; font-style: italic"># 使用 FileResponse 返回文件内容</span><br  \>        <span style="color: #007020; font-weight: bold">return</span> FileResponse(audio_file_path, filename<span style="color: #666666">=</span><span style="color: #4070a0">&quot;output.wav&quot;</span>, media_type<span style="color: #666666">=</span><span style="color: #4070a0">&quot;audio/wav&quot;</span>)<br  \>    <span style="color: #007020; font-weight: bold">else</span>:<br  \>        <span style="color: #007020">print</span>(<span style="color: #4070a0">&quot;audio_file_path: &quot;</span> <span style="color: #666666">+</span> audio_file_path)<br  \>        <span style="color: #007020">print</span>(speech_synthesis_result)<br  \>        <span style="color: #007020; font-weight: bold">return</span> {<span style="color: #4070a0">&quot;error&quot;</span>: <span style="color: #4070a0">&quot;File not found&quot;</span>}, <span style="color: #40a070">404</span><br  \><br  \><span style="color: #007020; font-weight: bold">if</span> <span style="color: #bb60d5">__name__</span> <span style="color: #666666">==</span> <span style="color: #4070a0">&quot;__main__&quot;</span>:<br  \>    uvicorn<span style="color: #666666">.</span>run(app, host<span style="color: #666666">=</span><span style="color: #4070a0">&quot;0.0.0.0&quot;</span>, port<span style="color: #666666">=</span><span style="color: #40a070">8000</span>)<br  \></code></pre></div><section><strong><span style="font-size: 17px;"><strong                style="color: rgb(90, 120, 234);font-size: 17px;letter-spacing: normal;text-align: left;">----------------</strong><br /></span></strong><section style="letter-spacing: 0.544px;text-indent: 0em;white-space: normal;background-color: rgb(255, 255, 255);"><strong><span style="font-size: 17px;"></span></strong><span            style="font-size: 17px;color: rgb(255, 64, 129);"><strong>部署</strong></span>    </section><section style="letter-spacing: 0.544px;text-indent: 0em;white-space: normal;background-color: rgb(255, 255, 255);">        <span style="font-size: 17px;color: rgb(255, 64, 129);"><strong><br /></strong></span>    </section></section><ol><li>服务器用的ubuntu，将上面python代码和config.ini放到/home/ubuntu/tts中</li><li>python执行代码提供服务</li><li>配置域名，将域名指向服务器</li></ol><section><strong><span style="font-size: 17px;"><strong                style="color: rgb(90, 120, 234);font-size: 17px;letter-spacing: normal;text-align: left;">----------------</strong><br /></span></strong><section style="letter-spacing: 0.544px;text-indent: 0em;white-space: normal;background-color: rgb(255, 255, 255);"><strong><span style="font-size: 17px;"></span></strong><span            style="font-size: 17px;color: rgb(255, 64, 129);"><strong>编写香色tts源</strong></span>    </section><section style="letter-spacing: 0.544px;text-indent: 0em;white-space: normal;background-color: rgb(255, 255, 255);">        <span style="font-size: 17px;color: rgb(255, 64, 129);"><strong><br /></strong></span>    </section></section><ul><li>可以从香色中导出一个语音源，使用下列代码转换成json格式。修改json中内容，然后再转换成xbs在香色中导入即可。</li></ul><div class="codehilite" style="background: #f0f0f0"><pre style="line-height: 125%;"><span></span><code style="font-size: 13.6px;padding: 0.2em 0.4em;border-radius: 3px;display: block;overflow: auto;text-wrap: wrap;font-family: mononoki, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace, &quot;Apple Color Emoji&quot;, &quot;Segoe UI Emoji&quot;, &quot;Noto Color Emoji&quot;, &quot;Segoe UI Symbol&quot;, &quot;Android Emoji&quot;, EmojiSymbols;background-size: 20px 20px;background-image: none;word-break: break-word;overflow-wrap: normal;background-color: rgba(27, 31, 35, 0.05);max-height: 1000px;color: var(--vscode-editor-foreground) !important;border-color: var(--vscode-quickInputTitle-background) !important;"><span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">xxtea</span><br  \><span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">struct</span><br  \><span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">os</span><br  \><span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">json</span><br  \><br  \><br  \>xxtea_key <span style="color: #666666">=</span> <span style="color: #007020">bytes</span>([<span style="color: #40a070">0xe5</span>, <span style="color: #40a070">0x87</span>, <span style="color: #40a070">0xbc</span>, <span style="color: #40a070">0xe8</span>, <span style="color: #40a070">0xa4</span>, <span style="color: #40a070">0x86</span>, <span style="color: #40a070">0xe6</span>, <span style="color: #40a070">0xbb</span>, <span style="color: #40a070">0xbf</span>, <span style="color: #40a070">0xe9</span>, <span style="color: #40a070">0x87</span>, <span style="color: #40a070">0x91</span>, <span style="color: #40a070">0xe6</span>, <span style="color: #40a070">0xba</span>, <span style="color: #40a070">0xa1</span>, <span style="color: #40a070">0xe5</span>])<br  \><br  \><span style="color: #007020; font-weight: bold">def</span> <span style="color: #06287e">xbs2json</span>(buffer):<br  \><br  \>    <span style="color: #007020; font-weight: bold">try</span>:<br  \>        out <span style="color: #666666">=</span> xxtea<span style="color: #666666">.</span>decrypt(buffer, xxtea_key,<span style="color: #007020; font-weight: bold">False</span>, <span style="color: #40a070">0</span>)<br  \>    <span style="color: #007020; font-weight: bold">except</span> <span style="color: #007020">Exception</span> <span style="color: #007020; font-weight: bold">as</span> e:<br  \>        <span style="color: #007020; font-weight: bold">return</span> <span style="color: #007020; font-weight: bold">None</span>, <span style="color: #007020">str</span>(e)<br  \><br  \>    n <span style="color: #666666">=</span> <span style="color: #007020">len</span>(buffer)<br  \>    n <span style="color: #666666">-=</span> <span style="color: #40a070">4</span><br  \>    m <span style="color: #666666">=</span> struct<span style="color: #666666">.</span>unpack(<span style="color: #4070a0">&#39;&lt;I&#39;</span>, out[n:])[<span style="color: #40a070">0</span>]<br  \><br  \>    <span style="color: #007020; font-weight: bold">if</span> m <span style="color: #666666">&lt;</span> n <span style="color: #666666">-</span> <span style="color: #40a070">3</span> <span style="color: #007020; font-weight: bold">or</span> m <span style="color: #666666">&gt;</span> n:<br  \>        <span style="color: #007020; font-weight: bold">return</span> <span style="color: #007020; font-weight: bold">None</span>, <span style="color: #4070a0">&quot;decode error&quot;</span><br  \><br  \>    n <span style="color: #666666">=</span> m<br  \>    <span style="color: #007020; font-weight: bold">return</span> out[:n], <span style="color: #007020; font-weight: bold">None</span><br  \><br  \><span style="color: #007020; font-weight: bold">def</span> <span style="color: #06287e">json2xbs</span>(buffer):<br  \>    buffer_len <span style="color: #666666">=</span> <span style="color: #007020">len</span>(buffer)<br  \>    n <span style="color: #666666">=</span> buffer_len <span style="color: #666666">//</span> <span style="color: #40a070">4</span><br  \>    <span style="color: #007020; font-weight: bold">if</span> buffer_len <span style="color: #666666">%</span> <span style="color: #40a070">4</span> <span style="color: #666666">!=</span> <span style="color: #40a070">0</span>:<br  \>        n <span style="color: #666666">+=</span> <span style="color: #40a070">1</span><br  \><br  \>    <span style="color: #60a0b0; font-style: italic"># Pad the buffer to the next multiple of 4</span><br  \>    padding_length <span style="color: #666666">=</span> n <span style="color: #666666">*</span> <span style="color: #40a070">4</span> <span style="color: #666666">-</span> buffer_len<br  \>    buffer_enc_len <span style="color: #666666">=</span> <span style="color: #4070a0">b&#39;</span><span style="color: #4070a0; font-weight: bold">\x00</span><span style="color: #4070a0">&#39;</span> <span style="color: #666666">*</span> padding_length<br  \><br  \>    <span style="color: #60a0b0; font-style: italic"># Append the original buffer length as a little-endian uint32</span><br  \>    buffer_enc_len <span style="color: #666666">+=</span> struct<span style="color: #666666">.</span>pack(<span style="color: #4070a0">&#39;&lt;I&#39;</span>, buffer_len)<br  \><br  \>    <span style="color: #60a0b0; font-style: italic"># Combine the original buffer with the padding and length</span><br  \>    buffer <span style="color: #666666">=</span> buffer <span style="color: #666666">+</span> buffer_enc_len<br  \><br  \>    <span style="color: #007020; font-weight: bold">try</span>:<br  \>        <span style="color: #60a0b0; font-style: italic"># Encrypt the buffer using XXTEA</span><br  \>        out <span style="color: #666666">=</span> xxtea<span style="color: #666666">.</span>encrypt(buffer, xxtea_key,<span style="color: #007020; font-weight: bold">False</span>, <span style="color: #40a070">0</span>)<br  \>        <span style="color: #007020; font-weight: bold">return</span> out, <span style="color: #007020; font-weight: bold">None</span><br  \>    <span style="color: #007020; font-weight: bold">except</span> <span style="color: #007020">Exception</span> <span style="color: #007020; font-weight: bold">as</span> e:<br  \>        <span style="color: #007020; font-weight: bold">return</span> <span style="color: #007020; font-weight: bold">None</span>, <span style="color: #007020">str</span>(e)<br  \><br  \><span style="color: #007020; font-weight: bold">def</span> <span style="color: #06287e">load_file</span>(filepath):<br  \>    <span style="color: #007020; font-weight: bold">if</span> os<span style="color: #666666">.</span>path<span style="color: #666666">.</span>exists(filepath):<br  \>        <span style="color: #007020; font-weight: bold">with</span> <span style="color: #007020">open</span>(filepath, <span style="color: #4070a0">&#39;rb&#39;</span>) <span style="color: #007020; font-weight: bold">as</span> file:<br  \>            <span style="color: #007020; font-weight: bold">return</span> file<span style="color: #666666">.</span>read(),<span style="color: #007020; font-weight: bold">None</span><br  \>    <span style="color: #007020; font-weight: bold">else</span>:<br  \>        <span style="color: #007020; font-weight: bold">return</span> <span style="color: #007020; font-weight: bold">None</span>, <span style="color: #4070a0">f&quot;File </span><span style="color: #70a0d0; font-style: italic">{</span>filepath<span style="color: #70a0d0; font-style: italic">}</span><span style="color: #4070a0"> does not exist.&quot;</span><br  \><br  \><span style="color: #007020; font-weight: bold">def</span> <span style="color: #06287e">xbs_to_json</span>(<span style="color: #007020">input</span>,output):<br  \>    data, error <span style="color: #666666">=</span> load_file(<span style="color: #007020">input</span>)<br  \>    <span style="color: #007020; font-weight: bold">if</span> error:<br  \>        <span style="color: #007020">print</span>(error)<br  \>        exit(<span style="color: #40a070">1</span>)<br  \>    encode_data,error <span style="color: #666666">=</span> xbs2json(data)<br  \>    <span style="color: #007020; font-weight: bold">if</span> error:<br  \>        <span style="color: #007020">print</span>(error)<br  \>        exit(<span style="color: #40a070">1</span>)<br  \>    <span style="color: #60a0b0; font-style: italic"># 打开文件以二进制模式写入</span><br  \>    <span style="color: #007020; font-weight: bold">with</span> <span style="color: #007020">open</span>(output, <span style="color: #4070a0">&#39;w&#39;</span>, encoding<span style="color: #666666">=</span><span style="color: #4070a0">&#39;utf-8&#39;</span>) <span style="color: #007020; font-weight: bold">as</span> f:<br  \>        json_data <span style="color: #666666">=</span> json<span style="color: #666666">.</span>loads(encode_data<span style="color: #666666">.</span>decode(<span style="color: #4070a0">&#39;utf-8&#39;</span>))<br  \>        json<span style="color: #666666">.</span>dump(json_data, f, ensure_ascii<span style="color: #666666">=</span><span style="color: #007020; font-weight: bold">False</span>, indent<span style="color: #666666">=</span><span style="color: #40a070">4</span>)<br  \><span style="color: #007020; font-weight: bold">def</span> <span style="color: #06287e">json_to_xbs</span>(<span style="color: #007020">input</span>,output):<br  \>    data, error <span style="color: #666666">=</span> load_file(<span style="color: #007020">input</span>)<br  \>    <span style="color: #007020; font-weight: bold">if</span> error:<br  \>        <span style="color: #007020">print</span>(error)<br  \>        exit(<span style="color: #40a070">1</span>)<br  \>    decode_data,error <span style="color: #666666">=</span> json2xbs(data)<br  \>    <span style="color: #007020; font-weight: bold">if</span> error:<br  \>        <span style="color: #007020">print</span>(error)<br  \>        exit(<span style="color: #40a070">1</span>)<br  \>    <span style="color: #007020; font-weight: bold">with</span> <span style="color: #007020">open</span>(output, <span style="color: #4070a0">&#39;wb&#39;</span>) <span style="color: #007020; font-weight: bold">as</span> f:<br  \>        f<span style="color: #666666">.</span>write(decode_data)<br  \><br  \><span style="color: #007020; font-weight: bold">if</span> <span style="color: #bb60d5">__name__</span> <span style="color: #666666">==</span> <span style="color: #4070a0">&#39;__main__&#39;</span>:<br  \>    xbs_to_json(<span style="color: #4070a0">&#39;D:</span><span style="color: #4070a0; font-weight: bold">\\</span><span style="color: #4070a0">workspace</span><span style="color: #4070a0; font-weight: bold">\\</span><span style="color: #4070a0">script</span><span style="color: #4070a0; font-weight: bold">\\</span><span style="color: #4070a0">xs</span><span style="color: #4070a0; font-weight: bold">\\</span><span style="color: #4070a0">test</span><span style="color: #4070a0; font-weight: bold">\\</span><span style="color: #4070a0">azure_tts.xbs&#39;</span> , <span style="color: #4070a0">&#39;D:</span><span style="color: #4070a0; font-weight: bold">\\</span><span style="color: #4070a0">workspace</span><span style="color: #4070a0; font-weight: bold">\\</span><span style="color: #4070a0">script</span><span style="color: #4070a0; font-weight: bold">\\</span><span style="color: #4070a0">xs</span><span style="color: #4070a0; font-weight: bold">\\</span><span style="color: #4070a0">test</span><span style="color: #4070a0; font-weight: bold">\\</span><span style="color: #4070a0">azure_tts1.json&#39;</span>)<br  \>    json_to_xbs(<span style="color: #4070a0">&#39;D:</span><span style="color: #4070a0; font-weight: bold">\\</span><span style="color: #4070a0">workspace</span><span style="color: #4070a0; font-weight: bold">\\</span><span style="color: #4070a0">script</span><span style="color: #4070a0; font-weight: bold">\\</span><span style="color: #4070a0">xs</span><span style="color: #4070a0; font-weight: bold">\\</span><span style="color: #4070a0">test</span><span style="color: #4070a0; font-weight: bold">\\</span><span style="color: #4070a0">azure_tts1.json&#39;</span> , <span style="color: #4070a0">&#39;D:</span><span style="color: #4070a0; font-weight: bold">\\</span><span style="color: #4070a0">workspace</span><span style="color: #4070a0; font-weight: bold">\\</span><span style="color: #4070a0">script</span><span style="color: #4070a0; font-weight: bold">\\</span><span style="color: #4070a0">xs</span><span style="color: #4070a0; font-weight: bold">\\</span><span style="color: #4070a0">test</span><span style="color: #4070a0; font-weight: bold">\\</span><span style="color: #4070a0">azure_tts1.xbs&#39;</span>)<br  \></code></pre></div><ul><li>修改点为requestInfo中url调整为自己服务的域名，body只保留voice_id参数。</li><li>requestFilters调整为Azure TTS音色信息，与上面config.ini中id对应。</li></ul><div class="codehilite" style="background: #f0f0f0"><pre style="line-height: 125%;"><span></span><code style="font-size: 13.6px;padding: 0.2em 0.4em;border-radius: 3px;display: block;overflow: auto;text-wrap: wrap;font-family: mononoki, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace, &quot;Apple Color Emoji&quot;, &quot;Segoe UI Emoji&quot;, &quot;Noto Color Emoji&quot;, &quot;Segoe UI Symbol&quot;, &quot;Android Emoji&quot;, EmojiSymbols;background-size: 20px 20px;background-image: none;word-break: break-word;overflow-wrap: normal;background-color: rgba(27, 31, 35, 0.05);max-height: 1000px;color: var(--vscode-editor-foreground) !important;border-color: var(--vscode-quickInputTitle-background) !important;">{<br  \>    &quot;语音设置-azure&quot;: {<br  \>        &quot;chapterContent&quot;: {<br  \>            &quot;actionID&quot;: &quot;chapterContent&quot;,<br  \>            &quot;parserID&quot;: &quot;DOM&quot;<br  \>        },<br  \>        &quot;enable&quot;: 1,<br  \>        &quot;shupingList&quot;: {<br  \>            &quot;actionID&quot;: &quot;shupingList&quot;,<br  \>            &quot;parserID&quot;: &quot;DOM&quot;<br  \>        },<br  \>        &quot;authorId&quot;: &quot;&quot;,<br  \>        &quot;bookDetail&quot;: {<br  \>            &quot;actionID&quot;: &quot;bookDetail&quot;,<br  \>            &quot;parserID&quot;: &quot;DOM&quot;<br  \>        },<br  \>        &quot;bookWorld&quot;: {<br  \>            &quot;azure&quot;: {<br  \>                &quot;actionID&quot;: &quot;bookWorld&quot;,<br  \>                &quot;validConfig&quot;: &quot;&quot;,<br  \>                &quot;requestInfo&quot;: &quot;@js:\n\nlet url=\&quot;https://tts.xiaoshame1.pp.ua/tts/\&quot;;\nlet body={\n    voice_id:params.filters.type,\n};\nlet _conf={\n      key:&#39;text&#39;,\n      body:body,\n      headers:{},\n      post:false,\n      url:url\n };\n\nparams.nativeTool.setCache(\&quot;xsreader_voice_conf\&quot;,JSON.stringify(_conf));\nreturn config.host&quot;,<br  \>                &quot;bookName&quot;: &quot;@js:\nlet regt=`\\n\\s*(.*?)::${params.filters.type}\\n`\nlet reg=new RegExp(regt)\nlet name=config.moreKeys.requestFilters.match(reg)[1]\nreturn \&quot;当前语音：\&quot;+name&quot;,<br  \>                &quot;detailUrl&quot;: &quot;@js:\nreturn config.host&quot;,<br  \>                &quot;host&quot;: &quot;http://captive.apple.com&quot;,<br  \>                &quot;_sIndex&quot;: 7,<br  \>                &quot;list&quot;: &quot;//title&quot;,<br  \>                &quot;responseFormatType&quot;: &quot;html&quot;,<br  \>                &quot;parserID&quot;: &quot;DOM&quot;,<br  \>                &quot;moreKeys&quot;: {<br  \>                    &quot;pageSize&quot;: 30,<br  \>                    &quot;requestFilters&quot;: &quot;type\n晓晓::Xiaoxiao\n云希::Yunxi\n云健::Yunjian\n晓伊::Xiaoyi\n云扬::Yunyang\n晓辰::Xiaochen\n晓涵::Xiaohan\n晓梦::Xiaomeng\n晓墨::Xiaomo\n晓秋::Xiaoqiu\n晓睿::Xiaorui\n晓双::Xiaoshuang\n晓晓 方言::Xiaoxiao Dialects\n晓晓 多语言::Xiaoxiao Multilingual\n晓颜::Xiaoyan\n晓悠::Xiaoyou\n晓甄::Xiaozhen\n云枫::Yunfeng\n云皓::Yunhao\n云夏::Yunxia\n云野::Yunye\n云泽::Yunze\n晓萱::Xiaoxuan\n曉臻::HsiaoChen\n雲哲::YunJhe\n曉雨::HsiaoYu&quot;<br  \>                }<br  \>            }<br  \>        },<br  \>        &quot;shudanList&quot;: {},<br  \>        &quot;sourceType&quot;: &quot;text&quot;,<br  \>        &quot;relatedWord&quot;: {<br  \>            &quot;actionID&quot;: &quot;relatedWord&quot;,<br  \>            &quot;parserID&quot;: &quot;DOM&quot;<br  \>        },<br  \>        &quot;weight&quot;: &quot;9999&quot;,<br  \>        &quot;sourceName&quot;: &quot;语音设置-azure&quot;,<br  \>        &quot;sourceUrl&quot;: &quot;http://captive.apple.com&quot;,<br  \>        &quot;miniAppVersion&quot;: &quot;2.53.2&quot;,<br  \>        &quot;shudanDetail&quot;: {<br  \>            &quot;actionID&quot;: &quot;shudanDetail&quot;,<br  \>            &quot;parserID&quot;: &quot;DOM&quot;<br  \>        },<br  \>        &quot;lastModifyTime&quot;: &quot;1695541859.065246&quot;,<br  \>        &quot;shupingHome&quot;: {<br  \>            &quot;actionID&quot;: &quot;shupingHome&quot;,<br  \>            &quot;parserID&quot;: &quot;DOM&quot;<br  \>        },<br  \>        &quot;searchShudan&quot;: {<br  \>            &quot;actionID&quot;: &quot;searchShudan&quot;,<br  \>            &quot;parserID&quot;: &quot;DOM&quot;<br  \>        },<br  \>        &quot;searchBook&quot;: {<br  \>            &quot;actionID&quot;: &quot;searchBook&quot;,<br  \>            &quot;parserID&quot;: &quot;DOM&quot;<br  \>        },<br  \>        &quot;chapterList&quot;: {<br  \>            &quot;actionID&quot;: &quot;chapterList&quot;,<br  \>            &quot;parserID&quot;: &quot;DOM&quot;<br  \>        }<br  \>    }<br  \>}<br  \></code></pre></div><section><strong><span style="font-size: 17px;"><strong                style="color: rgb(90, 120, 234);font-size: 17px;letter-spacing: normal;text-align: left;">----------------</strong><br /></span></strong><section style="letter-spacing: 0.544px;text-indent: 0em;white-space: normal;background-color: rgb(255, 255, 255);"><strong><span style="font-size: 17px;"></span></strong><span            style="font-size: 17px;color: rgb(255, 64, 129);"><strong>使用</strong></span>    </section><section style="letter-spacing: 0.544px;text-indent: 0em;white-space: normal;background-color: rgb(255, 255, 255);">        <span style="font-size: 17px;color: rgb(255, 64, 129);"><strong><br /></strong></span>    </section></section><ol><li>发现中切换到导入的音色源，选择音色</li><li>文章点击朗读，发音中选择语音测试</li></ol><section><section style="margin-top: 10px; margin-bottom: 10px; text-align: center;"><section style="display: inline-block; vertical-align: top;"><section                    style="margin-bottom: -6px; line-height: 1em; padding-left: 2px; padding-right: 2px; font-size: 18px; color: rgb(72, 64, 64);">                <p><strong>总结</strong></p>            </section><section style="width: 100%; height: 10px; background-color: rgb(255, 202, 0);">                <br/>            </section>        </section>    </section></section><ol><li>此方案同样可以封装阿里云和百度云的TTS服务，只需要增加相应云服务API调用代码。</li><li>代码比较简单，云API调用按照官方文档的步骤来，fastapi相关代码借助GPT完成。</li><li>查看他人香色语音源可以比较快熟悉的编写规则，转换成json后编写效率更高。</li><li>相关代码可以在<span style="font-size: 15px; letter-spacing: 1px;">Github</span><sup class="footnote-ref" style="line-height: 0; color: #1e6bb8; font-weight: bold;">[2]</sup>上查看。</li></ol><h3 style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 20px;">        <span class="prefix" style="display: none;"></span><span class="content">参考资料</span><span                class="suffix"></span></h3><span id="fn1" class="footnote-item" style="display: flex; flex-direction :column"><div style="display: flex;"><span class="footnote-num" style="display: inline; width: 2%; background: none; font-size: 80%; opacity: 0.6; line-height: 26px; font-family: ptima-Regular, Optima, PingFangSC-light, PingFangTC-light, 'PingFang SC', Cambria, Cochin, Georgia, Times, 'Times New Roman', serif;">[1] </span><p style="padding-top: 8px; padding-bottom: 8px; display: inline; font-size: 14px; width: 90%; padding: 0px; margin: 0; line-height: 26px; color: black; word-break: break-all; width: calc(100%-50);">&nbsp官方文档: <em style="font-style: italic; color: black;">https://learn.microsoft.com/en-us/azure/ai-services/speech-service/get-started-text-to-speech?tabs=linux%2Cterminal&pivots=programming-language-python</em></p></div><div style="display: flex;"><span class="footnote-num" style="display: inline; width: 2%; background: none; font-size: 80%; opacity: 0.6; line-height: 26px; font-family: ptima-Regular, Optima, PingFangSC-light, PingFangTC-light, 'PingFang SC', Cambria, Cochin, Georgia, Times, 'Times New Roman', serif;">[2] </span><p style="padding-top: 8px; padding-bottom: 8px; display: inline; font-size: 14px; width: 90%; padding: 0px; margin: 0; line-height: 26px; color: black; word-break: break-all; width: calc(100%-50);">&nbspGithub: <em style="font-style: italic; color: black;">https://github.com/xiaoshame/script/tree/main/xs</em></p></div></span><p>文章不定期修改，因公众号无法同步修改，点击阅读原文阅读<p></section>